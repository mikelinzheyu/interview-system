name: CI/CD - Build & Deploy to Aliyun

# è§¦å‘æ¡ä»¶ï¼šæ¯æ¬¡æ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
on:
  push:
    branches:
      - main
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  # é˜¿é‡Œäº‘å®¹å™¨ä»“åº“é…ç½®
  REGISTRY: crpi-ez54q3vldx3th6xj.cn-hongkong.personal.cr.aliyuncs.com
  REGISTRY_NAMESPACE: ai_interview
  IMAGE_FRONTEND: ai_interview_frontend
  IMAGE_BACKEND: ai_interview_backend
  IMAGE_STORAGE: ai_interview_storage

jobs:
  # ============================================
  # Job 1: æ„å»ºå¹¶æ¨é€é•œåƒåˆ°é˜¿é‡Œäº‘ä»“åº“
  # ============================================
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Aliyun Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ secrets.ALIYUN_REGISTRY_USERNAME }}
          password: ${{ secrets.ALIYUN_REGISTRY_PASSWORD }}

      - name: Generate image tags
        id: meta
        run: |
          echo "tag=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "timestamp=$(date +%Y%m%d_%H%M%S)" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_FRONTEND }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_FRONTEND }}:latest

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_BACKEND }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_BACKEND }}:latest

      - name: Build and push Storage Service image
        uses: docker/build-push-action@v5
        with:
          context: ./backend-java
          file: ./backend-java/Dockerfile
          push: true
          tags: |
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_STORAGE }}:${{ steps.meta.outputs.tag }}
            ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_STORAGE }}:latest

      - name: Build Summary
        run: |
          echo "âœ… é•œåƒæ„å»ºå’Œæ¨é€æˆåŠŸï¼"
          echo "Frontend: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_FRONTEND }}:${{ steps.meta.outputs.tag }}"
          echo "Backend: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_BACKEND }}:${{ steps.meta.outputs.tag }}"
          echo "Storage: ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_STORAGE }}:${{ steps.meta.outputs.tag }}"

  # ============================================
  # Job 2: éƒ¨ç½²åˆ°ç”Ÿäº§æœåŠ¡å™¨
  # ============================================
  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.DEPLOY_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Deploy to Production Server
        run: |
          # æ£€æŸ¥æ‰€æœ‰å¿…éœ€çš„ Secrets
          if [ -z "${{ secrets.DEPLOY_HOST }}" ]; then
            echo "âŒ é”™è¯¯ï¼šDEPLOY_HOST Secret æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_USER }}" ]; then
            echo "âŒ é”™è¯¯ï¼šDEPLOY_USER Secret æœªé…ç½®"
            exit 1
          fi
          if [ -z "${{ secrets.DEPLOY_PRIVATE_KEY }}" ]; then
            echo "âŒ é”™è¯¯ï¼šDEPLOY_PRIVATE_KEY Secret æœªé…ç½®"
            exit 1
          fi

          # è®¾ç½® SSH ç«¯å£ï¼Œå¦‚æœæœªæŒ‡å®šåˆ™ä½¿ç”¨é»˜è®¤å€¼ 22
          PORT=${{ secrets.DEPLOY_PORT }}
          PORT=${PORT:-22}

          echo "æ­£åœ¨è¿æ¥åˆ°: ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:$PORT"

          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -p $PORT ${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }} << 'EOF'
          set -e

          echo "========== å¼€å§‹éƒ¨ç½² =========="

          # ç¡®ä¿éƒ¨ç½²ç›®å½•å­˜åœ¨
          mkdir -p ${{ secrets.DEPLOY_PATH }}
          cd ${{ secrets.DEPLOY_PATH }}

          # ===== ä» GitHub åŒæ­¥æœ€æ–°é…ç½®æ–‡ä»¶ï¼ˆå…³é”®æ­¥éª¤ï¼‰=====
          echo "æ­£åœ¨ä» GitHub åŒæ­¥é…ç½®æ–‡ä»¶..."
          if [ ! -d .git ]; then
            echo "é¦–æ¬¡éƒ¨ç½²ï¼Œå…‹éš†ä»“åº“..."
            git clone https://github.com/mikelinzheyu/interview-system.git .
          else
            echo "åç»­éƒ¨ç½²ï¼Œæ‹‰å–æœ€æ–°æ›´æ–°..."
            git fetch origin
            git reset --hard origin/main
          fi
          echo "âœ… é…ç½®æ–‡ä»¶åŒæ­¥å®Œæˆ"

          # ç™»å½•é˜¿é‡Œäº‘
          docker login -u ${{ secrets.ALIYUN_REGISTRY_USERNAME }} -p ${{ secrets.ALIYUN_REGISTRY_PASSWORD }} ${{ env.REGISTRY }}

          # æ‹‰å–æœ€æ–°é•œåƒ
          echo "æ­£åœ¨æ‹‰å–æœ€æ–°é•œåƒ..."
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_FRONTEND }}:latest
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_BACKEND }}:latest
          docker pull ${{ env.REGISTRY }}/${{ env.REGISTRY_NAMESPACE }}/${{ env.IMAGE_STORAGE }}:latest

          # åœæ­¢æ—§å®¹å™¨å¹¶æ¸…ç†å­¤ç«‹å®¹å™¨
          echo "æ­£åœ¨åœæ­¢æ—§å®¹å™¨å¹¶æ¸…ç†å­¤ç«‹å®¹å™¨..."
          docker-compose -f docker-compose.prod.yml down --remove-orphans || true

          # å¯åŠ¨æ–°å®¹å™¨
          echo "æ­£åœ¨å¯åŠ¨æ–°å®¹å™¨..."
          docker-compose -f docker-compose.prod.yml up -d

          # ç­‰å¾…æœåŠ¡å¯åŠ¨
          sleep 30

          # æ£€æŸ¥å®¹å™¨çŠ¶æ€
          echo "å®¹å™¨çŠ¶æ€ï¼š"
          docker-compose -f docker-compose.prod.yml ps

          echo "========== éƒ¨ç½²å®Œæˆ =========="
          EOF

      - name: Verify Deployment
        run: |
          echo "ç­‰å¾…åº”ç”¨å¯åŠ¨..."
          sleep 10

          # æ£€æŸ¥åº”ç”¨æ˜¯å¦å¯è®¿é—®
          if curl -f https://viewself.cn/ 2>/dev/null; then
            echo "âœ… åº”ç”¨ä¸»é¡µå¯è®¿é—®"
          else
            echo "âš ï¸  åº”ç”¨ä¸»é¡µæš‚æœªå°±ç»ªï¼Œä½†å¯èƒ½è¿˜åœ¨åˆå§‹åŒ–ä¸­"
          fi

          if curl -f https://viewself.cn/api/health 2>/dev/null; then
            echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
          else
            echo "âš ï¸  APIæš‚æœªå°±ç»ª"
          fi

      - name: Deployment Status
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"
            echo "åº”ç”¨åœ°å€: https://viewself.cn"
            echo "Grafana: https://viewself.cn:3000"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—"
          fi
