name: Deploy to Aliyun Server

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Ê£ÄÂá∫‰ª£Á†Å
      uses: actions/checkout@v3
      
    - name: ËÆæÁΩÆ SSH
      uses: webfactory/ssh-agent@v0.8.0
      with:
        ssh-private-key: ${{ secrets.SERVER_SSH_KEY }}
        
    - name: Ê∑ªÂä†ÊúçÂä°Âô®Âà∞ known_hosts
      run: |
        mkdir -p ~/.ssh
        ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts
        
    - name: ÈÉ®ÁΩ≤Âà∞ÊúçÂä°Âô®
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          set -e
          
          cd ${{ secrets.DEPLOY_PATH }}
          
          if [ ! -d ".git" ]; then
            echo "È¶ñÊ¨°ÈÉ®ÁΩ≤ÔºåÂÖãÈöÜ‰ªìÂ∫ì..."
            git clone https://github.com/mikelinzheyu/interview-system.git .
          fi
          
          echo "ÊãâÂèñÊúÄÊñ∞‰ª£Á†Å..."
          git fetch origin
          git reset --hard origin/main
          
          mkdir -p logs/backend logs/frontend logs/redis logs/proxy data/redis
          
          echo "ÂÅúÊ≠¢Áé∞ÊúâÊúçÂä°..."
          docker-compose down || true
          
          echo "ÊûÑÂª∫Âπ∂ÂêØÂä®ÊúçÂä°..."
          docker-compose up -d --build
          
          echo "Á≠âÂæÖÊúçÂä°ÂêØÂä®..."
          sleep 10
          
          echo "Ê£ÄÊü•ÊúçÂä°Áä∂ÊÄÅ..."
          docker-compose ps
          
          echo "Ê∏ÖÁêÜÊóßÈïúÂÉè..."
          docker image prune -f
          
          echo "‚úÖ ÈÉ®ÁΩ≤ÂÆåÊàêÔºÅ"
        ENDSSH
        
    - name: È™åËØÅÈÉ®ÁΩ≤Áä∂ÊÄÅ
      if: always()
      env:
        SERVER_HOST: ${{ secrets.SERVER_HOST }}
        SERVER_USER: ${{ secrets.SERVER_USER }}
        DEPLOY_PATH: ${{ secrets.DEPLOY_PATH }}
      run: |
        ssh $SERVER_USER@$SERVER_HOST << 'ENDSSH'
          cd ${{ secrets.DEPLOY_PATH }}
          echo "=== ÂÆπÂô®ËøêË°åÁä∂ÊÄÅ ==="
          docker-compose ps
        ENDSSH
        
    - name: ÈÉ®ÁΩ≤ÁªìÊûúÈÄöÁü•
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "üéâ ÈÉ®ÁΩ≤ÊµÅÁ®ãÊâßË°åÂÆåÊàêÔºÅ"
          echo "ÂâçÁ´ØËÆøÈóÆÂú∞ÂùÄ: http://${{ secrets.SERVER_HOST }}"
          echo "ÂêéÁ´Ø API Âú∞ÂùÄ: http://${{ secrets.SERVER_HOST }}:8080/api"
        else
          echo "‚ùå ÈÉ®ÁΩ≤Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êó•Âøó"
        fi
