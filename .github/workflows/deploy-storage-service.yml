# GitHub Actions 工作流 - 自动构建和部署存储服务
# 当代码推送到 main 分支时，自动构建 Docker 镜像并部署到云服务器

name: Deploy Storage Service to Cloud

on:
  push:
    branches:
      - main
    paths:
      - 'storage-service/**'
      - '.github/workflows/deploy-storage-service.yml'
  workflow_dispatch:  # 允许手动触发

env:
  REGISTRY: docker.io
  IMAGE_NAME: ${{ github.repository }}/storage-service

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # 1. 检出代码
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      # 2. 设置 Java
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: maven

      # 3. 构建 JAR 文件
      - name: Build with Maven
        run: |
          cd storage-service
          mvn clean package -DskipTests -q

      # 4. 构建 Docker 镜像
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Build Docker image
        run: |
          cd storage-service
          docker build -f Dockerfile.prod -t storage-service:${{ github.sha }} -t storage-service:latest .

      # 5. 部署到云服务器（通过SSH）
      - name: Deploy to cloud server
        env:
          CLOUD_SERVER_IP: ${{ secrets.CLOUD_SERVER_IP }}
          CLOUD_SERVER_USER: ${{ secrets.CLOUD_SERVER_USER }}
          CLOUD_SERVER_KEY: ${{ secrets.CLOUD_SERVER_KEY }}
          STORAGE_API_KEY: ${{ secrets.STORAGE_API_KEY }}
          REDIS_PASSWORD: ${{ secrets.REDIS_PASSWORD }}
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "================================================================"
          echo "验证部署所需的 Secrets..."
          echo "================================================================"

          # 检查关键 secrets 是否存在
          if [ -z "$CLOUD_SERVER_USER" ]; then
            echo "❌ 错误：CLOUD_SERVER_USER 未配置"
            exit 1
          fi

          if [ -z "$CLOUD_SERVER_KEY" ]; then
            echo "❌ 错误：CLOUD_SERVER_KEY 未配置"
            exit 1
          fi

          echo "✅ Secrets 验证通过"
          echo "正在连接到服务器: $CLOUD_SERVER_IP (用户: $CLOUD_SERVER_USER)"
          echo "================================================================"

          # 创建 SSH 密钥
          mkdir -p ~/.ssh
          echo "$CLOUD_SERVER_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H $CLOUD_SERVER_IP >> ~/.ssh/known_hosts 2>/dev/null || true

          # 测试 SSH 连接
          echo "测试 SSH 连接..."
          if ! ssh -i ~/.ssh/id_rsa -o ConnectTimeout=10 "$CLOUD_SERVER_USER@$CLOUD_SERVER_IP" echo "✅ SSH 连接成功"; then
            echo "❌ SSH 连接失败"
            exit 1
          fi

          echo ""
          echo "================================================================"
          echo "开始部署服务..."
          echo "================================================================"

          # 部署脚本
          # 注意：通过 export 显式传递 GITHUB_TOKEN，保证变量在远程环境中可用
          ssh -i ~/.ssh/id_rsa "$CLOUD_SERVER_USER@$CLOUD_SERVER_IP" "export GITHUB_TOKEN='$GITHUB_TOKEN'; bash -s" << 'REMOTE_EOF'
          set -e

          echo "远程服务器：准备部署环境..."

          # 彻底清理部署目录 - 删除后重建
          echo "清理并重建部署目录..."
          rm -rf /home/interview-system
          mkdir -p /home/interview-system

          cd /home/interview-system

          echo "克隆仓库..."
          # 使用 HTTPS + GitHub Token 认证
          git clone https://x-access-token:$GITHUB_TOKEN@github.com/${{ github.repository }}.git .

          # 进入存储服务目录
          cd storage-service

          echo "创建环境配置文件..."
          cat > .env.prod << ENDENV
          REDIS_PASSWORD=$REDIS_PASSWORD
          STORAGE_API_KEY=$STORAGE_API_KEY
          SPRING_PROFILES_ACTIVE=prod
          SERVER_PORT=8081
          SPRING_REDIS_HOST=interview-redis
          SPRING_REDIS_PORT=6379
          TZ=Asia/Shanghai
          JAVA_OPTS=-Xms512m -Xmx1024m -XX:+UseG1GC
          ENDENV

          echo "构建 Docker 镜像..."
          docker-compose -f docker-compose-prod.yml build

          echo "清理旧的容器和网络..."
          docker-compose -f docker-compose-prod.yml down -v || true

          # 强制清理可能的孤立容器和网络
          docker container prune -f 2>/dev/null || true
          docker network prune -f 2>/dev/null || true

          echo "等待端口释放..."
          sleep 5

          echo "启动服务..."
          docker-compose -f docker-compose-prod.yml up -d

          echo "服务启动中，请等待初始化..."
          # 先等待一个固定的时间，让应用有足够时间初始化
          sleep 15

          echo "开始健康检查..."
          RETRY_COUNT=0
          MAX_RETRIES=20

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # 先检查容器状态
            if ! docker-compose -f docker-compose-prod.yml ps interview-storage-service | grep -q "Up"; then
              echo "❌ 存储服务容器已停止，部署失败"
              docker-compose -f docker-compose-prod.yml logs --tail=50
              exit 1
            fi

            # 检查应用端口是否在监听（最可靠的方式）
            if timeout 3 bash -c "echo > /dev/tcp/localhost/8081" 2>/dev/null; then
              echo "✅ 服务端口已就绪，尝试 API 调用..."
              # 一旦端口就绪，再试一次 API 调用
              # 注意：GET /api/sessions 不需要API Key，但提供也不会有害
              HTTP_STATUS=$(curl -s -w "%{http_code}" --max-time 3 -o /tmp/response.json "http://localhost:8081/api/sessions" 2>/dev/null)

              if [ "$HTTP_STATUS" = "200" ]; then
                echo "✅ 服务健康检查通过！(HTTP $HTTP_STATUS)"
                break
              else
                echo "API返回状态码: $HTTP_STATUS，继续重试..."
              fi
            fi

            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "服务初始化中，5秒后重试... (尝试次数: $RETRY_COUNT/$MAX_RETRIES)"
              sleep 5
            fi
          done

          if [ $RETRY_COUNT -eq $MAX_RETRIES ]; then
            echo "❌ 服务在限定时间内未能启动，部署失败。"
            echo "容器日志（最后 100 行）："
            docker-compose -f docker-compose-prod.yml logs --tail=100
            exit 1
          fi

          echo "✅ 存储服务已成功部署！"
          REMOTE_EOF

          echo ""
          echo "================================================================"
          echo "✅ 部署完成！"
          echo "================================================================"

      # 6. 健康检查
      - name: Health check
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          STORAGE_API_KEY: ${{ secrets.STORAGE_API_KEY }}
        run: |
          sleep 15
          curl -f -H "Authorization: Bearer $STORAGE_API_KEY" https://$DOMAIN_NAME/api/sessions || exit 1
          echo "✅ 云服务器存储服务健康检查通过"

      # 7. 失败通知（可选）
      - name: Notify failure
        if: failure()
        run: |
          echo "❌ 部署失败！请检查日志"
          exit 1

  # 并行任务：健康检查
  health-check:
    runs-on: ubuntu-latest
    needs: build-and-deploy
    if: success()

    steps:
      - name: Check storage service health
        env:
          DOMAIN_NAME: ${{ secrets.DOMAIN_NAME }}
          STORAGE_API_KEY: ${{ secrets.STORAGE_API_KEY }}
        run: |
          for i in {1..5}; do
            echo "Health check attempt $i..."
            if curl -f -H "Authorization: Bearer $STORAGE_API_KEY" https://$DOMAIN_NAME/api/sessions; then
              echo "✅ 服务健康"
              exit 0
            fi
            sleep 5
          done
          echo "❌ 服务不可达"
          exit 1
