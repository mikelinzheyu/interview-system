================================================================================
        Workflow3 "åŠ è½½æ ‡å‡†ç­”æ¡ˆ"èŠ‚ç‚¹ æŠ¥é”™ - å®Œæ•´è¯Šæ–­å’Œä¿®å¤æ–¹æ¡ˆ
================================================================================

æŠ¥å‘Šæ—¥æœŸ: 2025-10-27
è¯Šæ–­çŠ¶æ€: âœ… å·²è¯Šæ–­ - é—®é¢˜æ˜ç¡®
ä¿®å¤æ–¹æ¡ˆ: âœ… å·²å‡†å¤‡ - å¯ç«‹å³å®æ–½

================================================================================
                           é—®é¢˜è¯Šæ–­
================================================================================

é”™è¯¯ç°è±¡:
"Output question is missing."

é—®é¢˜ä½ç½®:
"åŠ è½½æ ‡å‡†ç­”æ¡ˆ" (load_answer) èŠ‚ç‚¹ - ç¬¬155-218è¡Œ

æ ¹æœ¬åŸå› :
èŠ‚ç‚¹å®šä¹‰äº†3ä¸ªè¾“å‡ºå­—æ®µ (line 185-191):
  - error (type: string)
  - question (type: string)  â† å·²å®šä¹‰ä½†æœªè¿”å›ï¼
  - standard_answer (type: string)

ä½†æ˜¯è¿”å›çš„ä»£ç  (line 175-182) åªè¿”å›äº†2ä¸ªå­—æ®µ:
  {
    "overall_score": ...,
    "comprehensive_evaluation": ...,
    "standard_answer": ...,
    "error": ""
  }

ç¼ºå¤±çš„å­—æ®µ: question

å½±å“èŒƒå›´:
1. "åŠ è½½æ ‡å‡†ç­”æ¡ˆ"èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥
2. "ç»¼åˆè¯„ä»·ä¸æ‰“åˆ†"èŠ‚ç‚¹æ— æ³•ä½¿ç”¨ {{#load_answer.question#}} å˜é‡
3. æ•´ä¸ª Workflow3 å¤±è´¥ï¼Œè¿”å› "Output question is missing."

================================================================================
                         ä¿®å¤æ–¹æ¡ˆ
================================================================================

ä¿®å¤æ­¥éª¤:

1. åœ¨"åŠ è½½æ ‡å‡†ç­”æ¡ˆ"èŠ‚ç‚¹çš„ Python ä»£ç ä¸­æ·»åŠ  question å­—æ®µ

æ‰¾åˆ°ä»£ç çš„è¿™éƒ¨åˆ† (ç¬¬170-174è¡Œ):
    # ============ æŸ¥æ‰¾é—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆ ============
    standard_answer = ""
    if 'questions' in session_data and isinstance(session_data['questions'], list):
        for question in session_data['questions']:
            if question.get('id') == question_id:
                standard_answer = question.get('answer', '')
                break

ä¿®æ”¹ä¸º:
    # ============ æŸ¥æ‰¾é—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆ ============
    question_text = ""
    standard_answer = ""
    if 'questions' in session_data and isinstance(session_data['questions'], list):
        for q in session_data['questions']:
            if q.get('id') == question_id:
                question_text = q.get('question', '')  â† æ·»åŠ è¿™è¡Œ
                standard_answer = q.get('answer', '')
                break

2. æ›´æ–°è¿”å›è¯­å¥ (ç¬¬175-182è¡Œ)

å°†:
    return {
        "overall_score": overall_score if overall_score > 0 else 75,
        "comprehensive_evaluation": comprehensive_evaluation if comprehensive_evaluation else "æ— è¯„ä»·",
        "standard_answer": standard_answer,
        "error": ""
    }

æ”¹ä¸º:
    return {
        "question": question_text,  â† æ·»åŠ è¿™è¡Œ
        "standard_answer": standard_answer,
        "error": ""
    }

================================================================================
                     å®Œæ•´ä¿®å¤åçš„ä»£ç 
================================================================================

import json
import urllib.request
import urllib.error
import ssl

def main(session_id: str, question_id: str, comprehensive_evaluation: str = "", overall_score: int = 0) -> dict:
    """
    ä»å­˜å‚¨APIè·å–æ ‡å‡†ç­”æ¡ˆï¼Œç”¨äºè¯„åˆ†å¯¹æ¯”
    """

    # ============ é…ç½® ============
    api_base_url = "https://phrenologic-preprandial-jesica.ngrok-free.dev"
    api_key = "ak_live_a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"

    try:
        # ============ è·å–ä¼šè¯æ•°æ® ============
        get_url = f"{api_base_url}/api/sessions/{session_id}"
        get_req = urllib.request.Request(
            get_url,
            headers={
                'Authorization': f'Bearer {api_key}',
                'Content-Type': 'application/json'
            },
            method='GET'
        )

        ctx = ssl.create_default_context()
        ctx.check_hostname = False
        ctx.verify_mode = ssl.CERT_NONE

        with urllib.request.urlopen(get_req, context=ctx, timeout=30) as response:
            response_data = json.loads(response.read().decode('utf-8'))
            
            # å¤„ç†å“åº”æ ¼å¼ - APIå¯èƒ½è¿”å› data.questions æˆ– questions
            if 'data' in response_data:
                session_data = response_data['data']
            else:
                session_data = response_data

        # ============ æŸ¥æ‰¾é—®é¢˜çš„æ ‡å‡†ç­”æ¡ˆå’Œé—®é¢˜æ–‡æœ¬ ============
        question_text = ""
        standard_answer = ""
        
        if 'questions' in session_data and isinstance(session_data['questions'], list):
            for q in session_data['questions']:
                if q.get('id') == question_id:
                    question_text = q.get('question', '')  # â† è·å–é—®é¢˜æ–‡æœ¬
                    standard_answer = q.get('answer', '')
                    break

        # ============ è¿”å›ç»“æœ ============
        return {
            "question": question_text,  # â† å¿…é¡»è¿”å›æ­¤å­—æ®µ
            "standard_answer": standard_answer,
            "error": ""
        }

    except Exception as e:
        return {
            "question": "",
            "standard_answer": "",
            "error": f"è·å–å¤±è´¥: {str(e)}"
        }

================================================================================
                      å®æ–½æ­¥éª¤ (åœ¨ Dify ä¸­)
================================================================================

æ­¥éª¤1: æ‰“å¼€ Workflow3 ç¼–è¾‘å™¨
- ç™»å½• Dify: https://cloud.dify.ai
- æ‰“å¼€ "AIé¢è¯•å®˜-å·¥ä½œæµ3-è¯„åˆ†"
- è¿›å…¥ç¼–è¾‘æ¨¡å¼

æ­¥éª¤2: ç¼–è¾‘"åŠ è½½æ ‡å‡†ç­”æ¡ˆ"èŠ‚ç‚¹
- åŒå‡» "åŠ è½½æ ‡å‡†ç­”æ¡ˆ" èŠ‚ç‚¹
- è¿›å…¥ Python ä»£ç ç¼–è¾‘å™¨

æ­¥éª¤3: æ›¿æ¢ä»£ç 
- å¤åˆ¶ä¸Šé¢"å®Œæ•´ä¿®å¤åçš„ä»£ç "éƒ¨åˆ†
- å®Œå…¨æ›¿æ¢èŠ‚ç‚¹ä¸­çš„ Python ä»£ç 

æ­¥éª¤4: ä¿å­˜å¹¶å‘å¸ƒ
- ä¿å­˜èŠ‚ç‚¹ (Ctrl+S)
- è¿”å›å·¥ä½œæµç¼–è¾‘è§†å›¾
- ç‚¹å‡»å³ä¸Šè§’"å‘å¸ƒ"æŒ‰é’®
- é€‰æ‹©"æ›´æ–°å·²å‘å¸ƒçš„ç‰ˆæœ¬"
- ç­‰å¾…å‘å¸ƒæˆåŠŸ

æ­¥éª¤5: éªŒè¯ä¿®å¤
è¿è¡Œæµ‹è¯•å‘½ä»¤:
  node test-workflow3-focused.js

é¢„æœŸç»“æœ:
  âœ… Workflow3 è°ƒç”¨æˆåŠŸï¼
  - æ€»ä½“è¯„åˆ†: 85 (æˆ–å…¶ä»–åˆ†æ•°)
  - ç»¼åˆè¯„ä»·é•¿åº¦: 500+ å­—ç¬¦
  - è¿”å›æ‰€æœ‰8ä¸ªå­—æ®µ âœ…

================================================================================
                        å…³é”®ä¿®æ”¹æ€»ç»“
================================================================================

ä¿®æ”¹é¡¹ç›®:
1. å˜é‡é‡å‘½å: å¾ªç¯å˜é‡ä» 'question' æ”¹ä¸º 'q'
   - åŸå› : é¿å…ä¸è¿”å›å­—æ®µåå†²çª
   
2. æ·»åŠ  question_text å˜é‡:
   - è·å–é—®é¢˜çš„æ–‡æœ¬å†…å®¹
   - ç±»ä¼¼äºè·å– standard_answer

3. æ›´æ–°è¿”å›å­—å…¸:
   - æ·»åŠ  "question": question_text
   - ç§»é™¤ä¸å¿…è¦çš„ overall_score å’Œ comprehensive_evaluation
   
4. æ”¹è¿›é”™è¯¯å¤„ç†:
   - å¤„ç† API è¿”å›æ ¼å¼å·®å¼‚
   - å®Œæ•´çš„å¼‚å¸¸æ•è·

================================================================================
                        éªŒè¯æ£€æŸ¥æ¸…å•
================================================================================

ä¿®å¤å‰:
âŒ è¾“å‡ºç¼ºå°‘ question å­—æ®µ
âŒ èŠ‚ç‚¹æ‰§è¡Œå¤±è´¥
âŒ è¿”å› "Output question is missing." é”™è¯¯
âŒ Workflow3 æ— æ³•ç»§ç»­æ‰§è¡Œ

ä¿®å¤å:
âœ… è¾“å‡ºåŒ…å« question å­—æ®µ
âœ… èŠ‚ç‚¹æˆåŠŸæ‰§è¡Œ
âœ… è¿”å›æ‰€æœ‰å¿…éœ€å­—æ®µ
âœ… Workflow3 å®Œæ•´æ‰§è¡Œé“¾
âœ… æœ€ç»ˆè¾“å‡ºåŒ…å«8ä¸ªå­—æ®µ:
   1. session_id
   2. question_id
   3. candidate_answer
   4. question â† å·²ä¿®å¤
   5. standard_answer
   6. comprehensive_evaluation
   7. overall_score
   8. error

================================================================================
                          é¢„æœŸæ•ˆæœ
================================================================================

ä¿®å¤å‰çš„ Workflow3 æ‰§è¡Œç»“æœ:
{
  "status": "failed",
  "error": "Output question is missing.",
  "outputs": {}
}

ä¿®å¤åçš„ Workflow3 æ‰§è¡Œç»“æœ:
{
  "status": "succeeded",
  "outputs": {
    "session_id": "fae4a2cf-4435-4201-a4ad-180fedbcb922",
    "question_id": "fae4a2cf-4435-4201-a4ad-180fedbcb922-q1",
    "candidate_answer": "...",
    "question": "è¯·æè¿°ä½ åœ¨ç”Ÿäº§ç¯å¢ƒä¸­è®¾è®¡å¹¶å®ç°ä¸€ä¸ªåŸºäºJavaçš„å¾®æœåŠ¡ç³»ç»Ÿ...",
    "standard_answer": "...",
    "comprehensive_evaluation": "å€™é€‰äººçš„å›ç­”æ˜¾ç¤ºäº†...",
    "overall_score": 85,
    "error": ""
  }
}

================================================================================
                          ä¿®å¤éš¾åº¦
================================================================================

ä¿®å¤å¤æ‚åº¦: â­ éå¸¸ç®€å•
ä¿®æ”¹è¡Œæ•°: 8è¡Œä»£ç 
ä¿®å¤æ—¶é—´: 3-5åˆ†é’Ÿ
é£é™©ç­‰çº§: ğŸŸ¢ æ— é£é™©

================================================================================
