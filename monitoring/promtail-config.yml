# Promtail 日志收集代理配置
# 用于收集容器日志并发送到Loki

server:
  http_listen_port: 9080
  grpc_listen_port: 0
  log_level: info

positions:
  filename: /tmp/positions.yaml

clients:
  - url: http://loki:3100/loki/api/v1/push

scrape_configs:
  # ========== Docker 日志收集 ==========
  - job_name: docker
    docker_sd_configs:
      - host: unix:///var/run/docker.sock
    relabel_configs:
      # 使用容器名称作为标签
      - source_labels: ['__meta_docker_container_name']
        target_label: 'container_name'

      # 使用容器ID作为标签
      - source_labels: ['__meta_docker_container_id']
        target_label: 'container_id'

      # 使用容器标签
      - source_labels: ['__meta_docker_container_label_com_docker_compose_service']
        target_label: 'service'

      # 添加默认标签
      - replacement: 'docker'
        target_label: 'log_source'

      # 排除某些容器（如果需要）
      - source_labels: ['container_name']
        regex: 'cadvisor|prometheus|grafana'
        action: drop

  # ========== 文件日志收集 ==========
  - job_name: logs
    static_configs:
      # 后端日志
      - targets:
          - /logs/backend/access.log
          - /logs/backend/error.log
          - /logs/backend/app.log
        labels:
          job: backend
          log_type: application

      # 前端日志
      - targets:
          - /logs/frontend/access.log
          - /logs/frontend/error.log
        labels:
          job: frontend
          log_type: web_server

      # Redis日志
      - targets:
          - /logs/redis/redis.log
        labels:
          job: redis
          log_type: database

      # 代理日志
      - targets:
          - /logs/proxy/access.log
          - /logs/proxy/error.log
        labels:
          job: proxy
          log_type: web_server

    relabel_configs:
      # 将文件路径设置为标签
      - source_labels: ['__path__']
        regex: '.*/([^/]+)/.*\.log'
        target_label: 'log_file'

      # 添加日志源标签
      - replacement: 'file'
        target_label: 'log_source'

  # ========== Syslog 收集 ==========
  # - job_name: syslog
  #   syslog_sd_configs:
  #     - targets:
  #         - localhost
  #   relabel_configs:
  #     - source_labels: ['__syslog_message_hostname']
  #       target_label: hostname
  #     - source_labels: ['__syslog_message_app_name']
  #       target_label: app

  # ========== Windows 事件日志 ==========
  # - job_name: eventlog
  #   windows_events_sd_configs:
  #     - eventlog_name: 'Application'
  #   relabel_configs:
  #     - source_labels: ['__meta_windows_eventlog_computer']
  #       target_label: host

# ========== 日志处理管道 ==========
# 用于解析和处理日志数据

# 示例：提取HTTP状态码
# - job_name: http_logs
#   pipeline_stages:
#     - regex:
#         expression: '.*(?P<status>[0-9]{3}).*'
#     - labels:
#         status:
#     - metrics:
#         http_requests_total:
#           type: counter
#           description: Total HTTP requests
#           match_all: true
#           action: inc

# 示例：提取错误日志
# - job_name: error_logs
#   static_configs:
#     - targets:
#         - /logs/backend/error.log
#       labels:
#         job: backend_errors
#   pipeline_stages:
#     # 仅保留ERROR级别的日志
#     - match:
#         selector: '{log_type="application"}'
#         stages:
#           - filter:
#               match:
#                 - "ERROR"
#               action: keep
#     # 提取错误消息
#     - json:
#         expressions:
#           error_type: error_type
#           message: message
#           timestamp: timestamp
#     - labels:
#         error_type:
