# 📋 执行步骤 - 一步步操作指南

## 🎯 现在的任务

你看到了工作流 1 返回的错误：
```json
{
  "error": "保存失败: HTTP Error 503: Service Unavailable",
  "session_id": ""
}
```

这是 **之前已诊断的问题**。现在我们要用 nginx 替代 ngrok 来解决。

---

## 📋 执行清单（8 个步骤）

### ✅ 步骤 1️⃣: 安装并启动 nginx (5 分钟)

**打开命令行（管理员模式）：**

```bash
# 1. 进入项目目录
cd D:\code7\interview-system

# 2. 运行自动安装脚本
setup-nginx.bat

# 3. 等待完成
# 脚本会：
# - 下载 nginx
# - 配置 nginx
# - 启动 nginx
# - 显示完成信息

# 4. 脚本完成后，您会看到类似：
# ================================================
#      安装完成!
# ================================================
```

**验证 nginx 运行：**

```bash
# 在新的命令行窗口执行
curl http://localhost/health

# 应该看到: OK
```

---

### ✅ 步骤 2️⃣: 启动存储服务 (在新的命令行窗口)

```bash
# 进入项目目录
cd D:\code7\interview-system

# 启动存储服务
node mock-storage-service.js

# 应该看到：
# Storage service listening on port 8080
```

保持这个窗口打开。

---

### ✅ 步骤 3️⃣: 测试 API 连接 (在新的命令行窗口)

```bash
# 测试存储服务的健康检查
curl http://localhost/health

# 应该返回: OK

# 测试 API 端点
curl -X POST http://localhost/api/sessions ^
  -H "Authorization: Bearer ak_live_a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0" ^
  -H "Content-Type: application/json" ^
  -d "{\"sessionId\": \"test\", \"jobTitle\": \"Python\"}"

# 应该返回 JSON 数据
```

如果成功，说明 nginx 和存储服务都在正常运行。

---

### ✅ 步骤 4️⃣: 更新 Dify 工作流 1 的 URL

**登录 Dify，打开工作流 1：**

访问: https://udify.app/workflow/sNkeofwLHukS3sC2

**编辑工作流：**

1. 点击右上角 "编辑" 按钮
2. 打开 "保存问题列表" 节点（Python 代码节点）
3. 找到这一行：
   ```python
   api_url = "http://localhost:8080/api/sessions"
   ```
4. 改为：
   ```python
   api_url = "http://localhost/api/sessions"
   ```
5. 点击 "保存"
6. 点击 "发布"
7. 等待 30 秒

---

### ✅ 步骤 5️⃣: 测试工作流 1 (在新的命令行窗口)

```bash
# 进入项目目录
cd D:\code7\interview-system

# 运行工作流 1 测试脚本
node test-workflow1-simple.js

# 应该看到：
# ✅ HTTP 状态: 200
# ✅ session_id: uuid-xxxxx (有值，不为空)
# ✅ questions: [...] (有问题，不是 [])
# ✅ job_title: 正确的职位
```

**关键检查点：**
- ✅ `session_id` 不为空
- ✅ `questions` 不是 []
- ✅ `question_count` > 0

---

### ✅ 步骤 6️⃣: 更新 Dify 工作流 2 和 3 的 URL

**工作流 2：**

访问: https://udify.app/workflow/rBRtFrkEqD9QuvcW

重复步骤 4️⃣ 的操作（修改 URL 为 `http://localhost/api/sessions`）

**工作流 3：**

访问: https://udify.app/workflow/6BP4LRMhhWAJErur

重复步骤 4️⃣ 的操作（修改 URL 为 `http://localhost/api/sessions`）

---

### ✅ 步骤 7️⃣: 测试工作流 2 和 3 (如果需要)

```bash
cd D:\code7\interview-system
node test-workflow2-3.js

# 观察输出，检查是否还有 504 错误
```

如果仍然有 504 错误，这可能是工作流内部的问题（例如变量映射），而不是存储服务的问题。

---

### ✅ 步骤 8️⃣: 完整端到端测试

```bash
# 1. 工作流 1 - 生成问题
node test-workflow1-simple.js

# 2. 检查输出是否正常
# 如果正常，继续进行工作流 2 和 3 的测试

# 3. 如果都通过，恭喜完成！
```

---

## 🎯 当前状态总结

| 项 | 状态 |
|----|------|
| nginx 配置 | ✅ 已准备 (nginx-windows.conf) |
| 自动安装脚本 | ✅ 已准备 (setup-nginx.bat) |
| 存储服务 | ✅ 已准备 (mock-storage-service.js) |
| 工作流 1 配置 | ⏳ 待更新 (改 URL) |
| 工作流 2 配置 | ⏳ 待更新 (改 URL) |
| 工作流 3 配置 | ⏳ 待更新 (改 URL) |

---

## 📊 预期结果

完成所有步骤后：

```
✅ nginx 在运行 (localhost:80)
✅ 存储服务在运行 (localhost:8080)
✅ API 可访问 (http://localhost/api/sessions)
✅ 工作流 1 返回有效数据 (session_id, questions, etc.)
✅ 工作流 2, 3 可以调用存储服务
```

---

## 🚨 常见问题

### Q1: setup-nginx.bat 执行失败？

**A:** 如果脚本失败：

1. 检查是否以管理员身份运行
2. 查看错误信息
3. 按照 `EXECUTE-NOW.txt` 中的方案 2 手动安装 nginx
4. 手动复制 `nginx-windows.conf` 到 `C:\nginx\conf\nginx.conf`
5. 手动启动 nginx

### Q2: curl 命令不工作？

**A:** 如果 curl 不可用：

1. 使用 PowerShell 的 Invoke-WebRequest：
   ```powershell
   Invoke-WebRequest -Uri "http://localhost/health"
   ```

2. 或者打开浏览器访问：
   ```
   http://localhost/health
   ```

### Q3: 工作流仍然返回 503？

**A:** 这可能是因为：

1. ⏳ URL 还没有更新成功（再检查一遍是否保存并发布）
2. ⏳ 还在使用 ngrok 的旧 URL（确保已改成 `http://localhost/api/sessions`）
3. ⏳ 存储服务没有启动（检查 `node mock-storage-service.js` 的窗口）

---

## 🎓 理解发生了什么

### 之前 (使用 ngrok)
```
Dify 工作流 → ngrok 隧道 → localhost:8080 → 存储服务
问题: ngrok 地址每次都变
```

### 现在 (使用 nginx)
```
Dify 工作流 → localhost:80 (nginx) → localhost:8080 → 存储服务
优势: localhost 地址永不变更
```

### 将来 (云服务器)
```
Dify 工作流 → api.yourdomain.com (nginx) → localhost:8080 → 存储服务
优势: 生产级别的稳定服务
```

---

## ✨ 现在就开始

**第 1 步：打开管理员命令行**

```
Win + X → 命令提示符(管理员)
```

**第 2 步：运行安装脚本**

```bash
cd D:\code7\interview-system
setup-nginx.bat
```

**第 3 步：按照上面的 8 个步骤逐步进行**

---

**预计完成时间：30 分钟（包括 Dify 工作流更新）**

祝顺利！ 🚀

