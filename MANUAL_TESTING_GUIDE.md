# å‰åç«¯è”è°ƒæ‰‹åŠ¨æµ‹è¯•æŒ‡å— - AI å¤šè½®å¯¹è¯åŠŸèƒ½

**ç”Ÿæˆæ—¶é—´**: 2025-11-17 15:30 UTC+8
**ç³»ç»ŸçŠ¶æ€**: âœ… åç«¯ (3001) + å‰ç«¯ (5174) å·²å¯åŠ¨

## ç³»ç»Ÿå¯åŠ¨çŠ¶æ€

```
âœ… åç«¯æœåŠ¡: http://localhost:3001
âœ… å‰ç«¯åº”ç”¨: http://localhost:5174
âœ… API ä»£ç†: /api -> http://localhost:3001
```

---

## æµ‹è¯•åœºæ™¯ï¼šå¤šè½® AI å¯¹è¯

### å‰ç½®æ¡ä»¶
- æµè§ˆå™¨å·²æ‰“å¼€å¼€å‘è€…å·¥å…·ï¼ˆF12ï¼‰
- æµè§ˆå™¨æ§åˆ¶å°å¯ä»¥æŸ¥çœ‹æ—¥å¿—
- ç½‘ç»œæ ‡ç­¾é¡µå¯ä»¥æŸ¥çœ‹ EventSource è¿æ¥

### æµ‹è¯•æµç¨‹

#### ç¬¬ 1 æ­¥: è®¿é—® AI å¯¹è¯åŠŸèƒ½

1. **æ‰“å¼€åº”ç”¨**
   - URL: `http://localhost:5174`
   - é¡µé¢åº”è¯¥æ­£å¸¸åŠ è½½

2. **å¯¼èˆªåˆ°ç¤¾åŒºåŠŸèƒ½** (Community)
   - ç‚¹å‡»å¯¼èˆªèœå•ä¸­çš„"ç¤¾åŒº"æˆ–ç›¸å…³é“¾æ¥
   - æˆ–ç›´æ¥è®¿é—®: `http://localhost:5174/#/community`

3. **é€‰æ‹©æˆ–åˆ›å»ºä¸€ä¸ªå¸–å­**
   - å¦‚æœåˆ—è¡¨ä¸ºç©ºï¼Œå¯èƒ½éœ€è¦åˆ›å»ºç¤ºä¾‹å¸–å­
   - æˆ–ç‚¹å‡»ç°æœ‰å¸–å­è¿›å…¥è¯¦æƒ…é¡µé¢

4. **æ‰“å¼€ AI åŠ©æ‰‹é¢æ¿**
   - åœ¨å¸–å­è¯¦æƒ…é¡µå³ä¾§åº”è¯¥æœ‰"AI åŠ©æ‰‹"é¢æ¿
   - æˆ–ç‚¹å‡»"å¯ç”¨ AI å¯¹è¯"æŒ‰é’®

#### ç¬¬ 2 æ­¥: å‘é€ç¬¬ä¸€æ¡æ¶ˆæ¯

1. **å‡†å¤‡æ¶ˆæ¯**
   - åœ¨èŠå¤©è¾“å…¥æ¡†è¾“å…¥: `ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹è¿™ç¯‡æ–‡ç« çš„ä¸»è¦å†…å®¹`

2. **å‘é€æ¶ˆæ¯**
   - ç‚¹å‡»"å‘é€"æŒ‰é’®æˆ–æŒ‰ Enter

3. **è§‚å¯Ÿç¬¬ä¸€æ¡æ¶ˆæ¯çš„å“åº”**
   ```
   é¢„æœŸç»“æœ:
   âœ… çœ‹åˆ° AI çš„å›å¤å†…å®¹é€å­—å‡ºç°ï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰
   âœ… å³ä¾§ AI æ¶ˆæ¯ä¼šé€æ­¥æ›´æ–°
   âœ… æ¶ˆæ¯å‘é€å®Œæˆåæ˜¾ç¤ºæˆåŠŸæç¤º
   âœ… æ²¡æœ‰é”™è¯¯æç¤º
   ```

4. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æ£€æŸ¥æ—¥å¿—**
   - F12 æ‰“å¼€å¼€å‘è€…å·¥å…· â†’ Console æ ‡ç­¾é¡µ
   - æŸ¥æ‰¾ç±»ä¼¼ä»¥ä¸‹æ—¥å¿—:
     ```
     [AI Assistant] ğŸ“Œ å¼€å§‹æ–°çš„å¯¹è¯
     [AI Assistant] Connecting to stream: http://localhost:3001/api/ai/chat/stream?...
     [AI Assistant] âœ… conversationId å·²ä¿å­˜: conv-test-post-001-...
     ```

#### ç¬¬ 3 æ­¥: å‘é€ç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆå…³é”®æµ‹è¯•ï¼‰

1. **å‡†å¤‡ç¬¬äºŒæ¡æ¶ˆæ¯**
   - åœ¨è¾“å…¥æ¡†è¾“å…¥: `èƒ½ä¸¾ä¸ªå…·ä½“çš„ä¾‹å­è¯´æ˜å—ï¼Ÿ`

2. **å‘é€æ¶ˆæ¯**
   - ç‚¹å‡»å‘é€

3. **è§‚å¯Ÿç¬¬äºŒæ¡æ¶ˆæ¯å“åº”**
   ```
   ğŸ”´ å…³é”®è§‚å¯Ÿç‚¹:
   âœ… åº”è¯¥æ¥æ”¶åˆ° AI å›å¤
   âŒ ä¸åº”è¯¥å‡ºç° "å¯¹è¯å‡ºé”™ï¼Œè¯·é‡è¯•" é”™è¯¯æ¶ˆæ¯
   âœ… æ¶ˆæ¯åº”è¯¥åœ¨ç”¨æˆ·é—®é¢˜ä¸‹æ–¹æ­£å¸¸æ˜¾ç¤º
   âœ… åº”è¯¥çœ‹åˆ°è¿ç»­çš„å¯¹è¯ä¸Šä¸‹æ–‡
   ```

4. **æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°**
   - æŸ¥æ‰¾ç¬¬äºŒæ¡æ¶ˆæ¯çš„æ—¥å¿—:
     ```
     [AI Assistant] ğŸ“Œ ç»§ç»­å¤šè½®å¯¹è¯ï¼ŒconversationId: conv-test-post-001-...
     [AI Assistant] Connecting to stream: http://localhost:3001/api/ai/chat/stream?conversationId=conv-...
     âœ… conversationId å·²ä¿å­˜: (åŒä¸€ä¸ªID)
     ```

5. **éªŒè¯ conversationId ä¸€è‡´æ€§**
   - ç¬¬ä¸€æ¡æ¶ˆæ¯åè·å¾—çš„ conversationId
   - ç¬¬äºŒæ¡æ¶ˆæ¯ä½¿ç”¨çš„ conversationId **åº”è¯¥å®Œå…¨ç›¸åŒ**
   - ç¤ºä¾‹: ä¸¤æ¡æ¶ˆæ¯éƒ½ä½¿ç”¨ `conv-test-post-001-user-lnc2nflop-1763392990654`

#### ç¬¬ 4 æ­¥: å‘é€ç¬¬ä¸‰æ¡æ¶ˆæ¯ï¼ˆéªŒè¯æŒç»­å¯¹è¯ï¼‰

1. **å‡†å¤‡ç¬¬ä¸‰æ¡æ¶ˆæ¯**
   - è¾“å…¥: `ç»§ç»­è§£é‡Šä¸€ä¸‹å¦‚ä½•å®ç°è¿™ä¸ªåŠŸèƒ½`

2. **å‘é€æ¶ˆæ¯**

3. **è§‚å¯Ÿç»“æœ**
   ```
   é¢„æœŸ:
   âœ… æ­£å¸¸æ¥æ”¶å›å¤
   âœ… æ²¡æœ‰ä»»ä½•é”™è¯¯
   âœ… å¯¹è¯å†å²å®Œæ•´æ˜¾ç¤º
   ```

---

## ç½‘ç»œæµé‡æ£€æŸ¥ï¼ˆé«˜çº§ï¼‰

### åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­

1. **æ‰“å¼€ Network æ ‡ç­¾é¡µ**
2. **æ‰¾åˆ° EventSource è¯·æ±‚**
   - è¿‡æ»¤: Type = `fetch` æˆ–ç›´æ¥æœç´¢ `chat/stream`
   - åº”è¯¥çœ‹åˆ°å¤šä¸ªè¯·æ±‚:
     ```
     GET /api/ai/chat/stream?message=...&conversationId=... 200
     GET /api/ai/chat/stream?message=...&conversationId=... 200
     GET /api/ai/chat/stream?message=...&conversationId=... 200
     ```

3. **æ£€æŸ¥æ¯ä¸ªè¯·æ±‚çš„æŸ¥è¯¢å‚æ•°**
   - ç‚¹å‡»è¯·æ±‚ â†’ Headers æ ‡ç­¾é¡µ
   - Query String Parameters:
     ```
     message: [ç”¨æˆ·çš„æ¶ˆæ¯]
     articleContent: [æ–‡ç« å†…å®¹]
     conversationId: [ç›¸åŒçš„ ID ç”¨äºå¤šè½®å¯¹è¯]
     token: dev-token-for-testing
     ```

4. **æ£€æŸ¥å“åº”**
   - Response æ ‡ç­¾é¡µåº”è¯¥çœ‹åˆ°æµå¼ SSE æ•°æ®:
     ```
     data: {"type":"chunk","content":"è¿™æ˜¯AIçš„å›å¤..."}
     data: {"type":"end","conversationId":"conv-test-post-001-..."}
     event: done
     ```

---

## å¸¸è§é—®é¢˜æ’æŸ¥

### é—®é¢˜ 1: "å¯¹è¯å‡ºé”™ï¼Œè¯·é‡è¯•" å‡ºç°åœ¨ç¬¬äºŒæ¡æ¶ˆæ¯

**è¯Šæ–­æ­¥éª¤**:
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°
2. æ£€æŸ¥æ˜¯å¦çœ‹åˆ°é”™è¯¯æ—¥å¿—
3. æŸ¥çœ‹ç½‘ç»œè¯·æ±‚æ˜¯å¦æˆåŠŸ (HTTP 200)
4. æ£€æŸ¥ conversationId æ˜¯å¦è¢«æ­£ç¡®ä¼ é€’

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿åç«¯æ­£åœ¨è¿è¡Œ: `curl http://localhost:3001/health`
- æ£€æŸ¥ conversationId æ˜¯å¦åœ¨ç¬¬ä¸€æ¡æ¶ˆæ¯åæ­£ç¡®ä¿å­˜
- æŸ¥çœ‹åç«¯æ—¥å¿—ç¡®è®¤è¯·æ±‚è¢«æ¥æ”¶

### é—®é¢˜ 2: conversationId æ¯æ¡æ¶ˆæ¯éƒ½åœ¨å˜åŒ–

**åŸå› **: conversationId æ²¡æœ‰è¢«æ­£ç¡®ä¿å­˜æˆ–ä¼ é€’

**æ£€æŸ¥**:
```
// åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰‹åŠ¨æµ‹è¯• conversationId ä¿å­˜
localStorage.getItem('authToken')  // åº”è¯¥æœ‰å€¼æˆ–ä¸ºç©ºå­—ç¬¦ä¸²
```

**è§£å†³**: éœ€è¦åœ¨å‰ç«¯ä»£ç ä¸­ç¡®ä¿ conversationId.value åœ¨æ¶ˆæ¯ä¹‹é—´è¢«æ­£ç¡®ä¿å­˜

### é—®é¢˜ 3: åç«¯è¿”å› 400 Bad Request

**åŸå› **: ç¼ºå°‘å¿…éœ€çš„æŸ¥è¯¢å‚æ•°

**æ£€æŸ¥**:
- ç¡®ä¿ `articleContent` å‚æ•°è¢«å‘é€
- ç¡®ä¿ `message` å‚æ•°è¢«å‘é€
- ç¡®ä¿ `token` å‚æ•°è¢«å‘é€

### é—®é¢˜ 4: EventSource è¿æ¥ç«‹å³æ–­å¼€

**åŸå› **: å¯èƒ½æ˜¯è®¤è¯é—®é¢˜æˆ– CORS é—®é¢˜

**æ£€æŸ¥**:
1. æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°æŸ¥çœ‹é”™è¯¯
2. æ£€æŸ¥ç½‘ç»œè¯·æ±‚çš„å“åº”å¤´ä¸­æ˜¯å¦æœ‰ CORS é”™è¯¯
3. ç¡®ä¿åç«¯æ­£ç¡®è®¾ç½®äº† CORS å¤´: `Access-Control-Allow-Origin: *`

---

## æˆåŠŸæŒ‡æ ‡

âœ… **å¤šè½®å¯¹è¯åŠŸèƒ½æ­£å¸¸å·¥ä½œçš„æ ‡å¿—**:

1. **ç¬¬ä¸€æ¡æ¶ˆæ¯** âœ…
   - [ ] æ”¶åˆ° AI å›å¤
   - [ ] æ˜¾ç¤º conversationId æ—¥å¿—
   - [ ] æ²¡æœ‰é”™è¯¯æ¶ˆæ¯

2. **ç¬¬äºŒæ¡æ¶ˆæ¯** âœ… **å…³é”®**
   - [ ] æ”¶åˆ° AI å›å¤
   - [ ] æ²¡æœ‰ "å¯¹è¯å‡ºé”™ï¼Œè¯·é‡è¯•"
   - [ ] conversationId ä¸ç¬¬ä¸€æ¡æ¶ˆæ¯ç›¸åŒ
   - [ ] æ—¥å¿—æ˜¾ç¤º "ğŸ“Œ ç»§ç»­å¤šè½®å¯¹è¯"

3. **ç¬¬ä¸‰æ¡æ¶ˆæ¯åŠä»¥å** âœ…
   - [ ] æ”¶åˆ° AI å›å¤
   - [ ] æ²¡æœ‰é”™è¯¯
   - [ ] conversationId ä¿æŒä¸€è‡´
   - [ ] å®Œæ•´å¯¹è¯å†å²æ˜¾ç¤º

---

## å®æ—¶æ—¥å¿—ç¤ºä¾‹

### æˆåŠŸçš„å¤šè½®å¯¹è¯æ—¥å¿—

```
[AI Assistant] ğŸ“Œ å¼€å§‹æ–°çš„å¯¹è¯
[AI Assistant] Connecting to stream: http://localhost:3001/api/ai/chat/stream?message=...
âœ¨ å·²è·å¾— conversationId: conv-test-post-001-user-123456-1763392990654
[AI Assistant] âœ… conversationId å·²ä¿å­˜: conv-test-post-001-user-123456-1763392990654

[ç¬¬äºŒæ¡æ¶ˆæ¯]
[AI Assistant] ğŸ“Œ ç»§ç»­å¤šè½®å¯¹è¯ï¼ŒconversationId: conv-test-post-001-user-123456-1763392990654
[AI Assistant] Connecting to stream: http://localhost:3001/api/ai/chat/stream?conversationId=conv-test-post-001-user-123456-1763392990654&...
[AI Assistant] âœ… conversationId å·²ä¿å­˜: conv-test-post-001-user-123456-1763392990654

[ç¬¬ä¸‰æ¡æ¶ˆæ¯]
[AI Assistant] ğŸ“Œ ç»§ç»­å¤šè½®å¯¹è¯ï¼ŒconversationId: conv-test-post-001-user-123456-1763392990654
```

---

## æŠ€æœ¯èƒŒæ™¯

### ç³»ç»Ÿæ¶æ„

```
å‰ç«¯ (Vue 3 + Vite)
    â†“
Vite ä»£ç† (/api â†’ localhost:3001)
    â†“
åç«¯ (Node.js + Express)
    â†“
EventSource (SSE) æµå¼å“åº”
    â†“
conversationId ç®¡ç†
```

### å…³é”®æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `frontend/src/views/community/PostDetail/components/NewAIAssistant.vue` | å‰ç«¯ AI å¯¹è¯ç»„ä»¶ |
| `backend/routes/ai.js` | åç«¯ AI è·¯ç”± |
| `backend/services/chatWorkflowService.js` | AI å·¥ä½œæµæœåŠ¡ |
| `backend/middleware/auth.js` | è®¤è¯ä¸­é—´ä»¶ |

---

## è°ƒè¯•æŠ€å·§

### å¯ç”¨æ›´è¯¦ç»†çš„æ—¥å¿—

åœ¨æµè§ˆå™¨æ§åˆ¶å°æ‰§è¡Œ:
```javascript
// å¯ç”¨è¯¦ç»†æ—¥å¿—
localStorage.setItem('debug', 'ai-*')
// åˆ·æ–°é¡µé¢
location.reload()
```

### æ‰‹åŠ¨æµ‹è¯• API

```bash
# æµ‹è¯•ç¬¬ä¸€æ¡æ¶ˆæ¯
curl "http://localhost:3001/api/ai/chat/stream?message=hello&articleContent=test&token=dev-token-for-testing"

# æµ‹è¯•ç¬¬äºŒæ¡æ¶ˆæ¯ï¼ˆä½¿ç”¨ conversationIdï¼‰
curl "http://localhost:3001/api/ai/chat/stream?message=continue&articleContent=test&conversationId=conv-test&token=dev-token-for-testing"
```

---

## ä¸‹ä¸€æ­¥

å¦‚æœæ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡ï¼Œå¤šè½® AI å¯¹è¯åŠŸèƒ½å·²å®Œå…¨å¯ç”¨ã€‚

å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›:
1. æµè§ˆå™¨æ§åˆ¶å°çš„å®Œæ•´é”™è¯¯æ—¥å¿—
2. ç½‘ç»œè¯·æ±‚çš„å“åº”å†…å®¹
3. åç«¯æ—¥å¿—è¾“å‡º
