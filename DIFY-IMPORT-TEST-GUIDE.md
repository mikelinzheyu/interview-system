# Dify 工作流导入测试指南

## 📋 问题分析

您遇到了 `400 Bad Request` 错误，这通常意味着 YAML 文件格式不符合 Dify 的要求。

---

## 🧪 测试步骤

### 步骤 1: 测试原始文件能否导入

我已经从 `D:\code7\test5` 复制了原始文件到项目目录:

**文件位置**: `D:\code7\interview-system\AI-Interview-Workflow-ORIGINAL.yml`
**文件大小**: 29,457 字节
**文件行数**: 923 行

**请先尝试导入这个原始文件**:
1. 打开 Dify 控制台
2. 点击"工作流" → "导入"
3. 选择 `AI-Interview-Workflow-ORIGINAL.yml`
4. 查看是否能成功导入

#### ✅ 如果原始文件导入成功
说明修改后的文件有问题,我们需要基于原始文件重新做最小化修改。

#### ❌ 如果原始文件也无法导入
说明可能是其他问题(如Dify版本不兼容、文件编码等)。

---

## 🔍 可能的导入失败原因

### 原因 1: 添加了环境变量
修改后的文件添加了环境变量配置:
```yaml
environment_variables:
  - description: 后端 API 地址 ...
    name: BACKEND_API_URL
    value: http://localhost:3000
    value_type: string
```

**原始文件**:
```yaml
environment_variables: []
```

### 原因 2: 代码节点过长
修改后的 `save_session` 和 `load_session` 节点代码比原始代码复杂很多,可能超过了 Dify 的限制。

### 原因 3: 转义字符问题
Python 代码中的转义字符(如 `\n`, `\"`, `\{`)在 YAML 中可能需要特殊处理。

### 原因 4: YAML 格式错误
修改过程中可能引入了格式错误。

---

## 💡 建议的修复策略

### 策略 A: 最小化修改 (推荐)
**如果原始文件能导入**,采用这个策略:

1. ✅ **只修改参数名**: `job_title` → `jobTitle`
2. ❌ **不修改代码节点**: 保持原样,先导入成功
3. ❌ **不添加环境变量**: 导入成功后在 Dify 界面手动配置
4. ✅ **更新变量引用**: 所有引用 `job_title` 的地方改为 `jobTitle`

导入成功后,再在 Dify 界面中:
- 手动修改 `save_session` 代码节点
- 手动修改 `load_session` 代码节点
- 手动添加环境变量

### 策略 B: 分阶段修改
1. **阶段 1**: 先导入原始文件
2. **阶段 2**: 在 Dify 界面手动修改 2 个代码节点
3. **阶段 3**: 导出修改后的 YAML 作为新版本

### 策略 C: 简化代码
如果代码节点太长导致导入失败,我们可以:
- 删除所有注释
- 简化错误处理逻辑
- 减少代码长度

---

## 📝 修改文件对比

| 文件 | 行数 | 环境变量 | save_session代码 | load_session代码 |
|------|------|----------|------------------|------------------|
| 原始文件 | 923 | 空 | 简单(UUID only) | 简单(模拟) |
| 修改后 | 970 | 1个 | 复杂(Redis API) | 复杂(Redis API) |
| 差异 | +47 | +1 | +25行 | +20行 |

---

## 🛠️ 下一步行动

### 选项 1: 先测试原始文件 (推荐)
```bash
# 文件位置
D:\code7\interview-system\AI-Interview-Workflow-ORIGINAL.yml
```
**请您尝试导入这个文件,然后告诉我结果。**

### 选项 2: 我创建一个最小化修改版本
我可以创建一个**只改参数名**的版本,不改代码节点,看能否导入成功。

### 选项 3: 检查 Dify 错误日志
如果您是自托管 Dify,可以查看详细错误:
```bash
docker-compose logs -f api
```

---

## 🔍 诊断清单

请检查以下项目:

- [ ] 确认使用的是 Dify Cloud 还是自托管
- [ ] 确认 Dify 版本号
- [ ] 确认文件编码是 UTF-8
- [ ] 确认文件大小是否在限制内 (<50MB)
- [ ] 原始文件能否成功导入
- [ ] 是否有详细的错误信息

---

## 📞 请告诉我

1. **原始文件 (`AI-Interview-Workflow-ORIGINAL.yml`) 能否导入成功?**
2. **您使用的是 Dify Cloud 还是自托管?**
3. **有没有更详细的错误信息?** (除了 400 状态码)

根据您的反馈,我可以:
- ✅ 创建最小化修改版本
- ✅ 提供 Dify 界面手动修改指南
- ✅ 帮助排查具体错误原因

---

**测试时间**: 2025-10-10
**状态**: 等待测试结果

