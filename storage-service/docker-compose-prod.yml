version: '3.8'

services:
  # Redis 缓存服务
  interview-redis:
    image: redis:7-alpine
    container_name: interview-redis
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    environment:
      - TZ=Asia/Shanghai
    command: redis-server --appendonly yes --requirepass redis-password-prod
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "redis-password-prod", "ping"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 10s
    networks:
      - interview-network
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # 存储服务
  interview-storage-service:
    build:
      context: .
      dockerfile: Dockerfile.prod
    container_name: interview-storage-service
    ports:
      - "8081:8081"
    depends_on:
      interview-redis:
        condition: service_healthy
    environment:
      # Java 相关
      JAVA_OPTS: "-Xms512m -Xmx1024m -XX:+UseG1GC -XX:MaxGCPauseMillis=200"

      # Spring 相关
      SPRING_PROFILES_ACTIVE: "prod"
      SERVER_PORT: "8081"

      # Redis 配置
      SPRING_REDIS_HOST: "interview-redis"
      SPRING_REDIS_PORT: "6379"
      SPRING_REDIS_PASSWORD: "redis-password-prod"
      SPRING_REDIS_TIMEOUT: "3000ms"
      SPRING_REDIS_LETTUCE_POOL_MAX_ACTIVE: "8"
      SPRING_REDIS_LETTUCE_POOL_MAX_IDLE: "8"

      # API Key 配置
      SESSION_STORAGE_API_KEY: "ak_live_a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0"

      # 日志配置
      LOGGING_LEVEL_COM_EXAMPLE_INTERVIEWSTORAGE: "INFO"
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_SECURITY: "WARN"
      LOGGING_LEVEL_ORG_SPRINGFRAMEWORK_DATA_REDIS: "INFO"

      # Jackson 配置
      SPRING_JACKSON_SERIALIZATION_INDENT_OUTPUT: "true"
      SPRING_JACKSON_DEFAULT_PROPERTY_INCLUSION: "non_null"
      SPRING_JACKSON_SERIALIZATION_WRITE_DATES_AS_TIMESTAMPS: "false"

      # 时区配置
      TZ: "Asia/Shanghai"

    volumes:
      - storage-logs:/app/logs
      - storage-data:/app/data

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8081/api/sessions"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s

    networks:
      - interview-network

    restart: unless-stopped

    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

volumes:
  redis-data:
    driver: local
  storage-logs:
    driver: local
  storage-data:
    driver: local

networks:
  interview-network:
    driver: bridge
